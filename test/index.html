<!DOCTYPE html>
<html lang="tr" class="no-js">
<head>
<title>Admin Authentication</title>
<meta charset="utf-8" />
<meta http-equiv="content-type" content="text/html;charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
<base href="/admin/authentication/" />
<script src="jquery-3.7.0.min.js"></script>
<script src="../qrcode.min.js"></script>
</head>
<body>

<h1>Admin Authentication Web App</h1>

<!--
<form action="/index.html" method="post" senctype="multipart/form-data">
	First Name: <input type="text" name="first_name" value="" /><br />
	Last Name : <input type="text" name="last_name" value="" /><br />

	<input type="submit" value="Send" />
</form>
-->

<div id="login-section">
	<form id="login-form" method="post" onsubmit="return false;">
		<dl>
			<dt>Username/Email</dt><dd><input type="text" name="username" id="username" value="admin@admin.com" /></dd>
			<dt>Password</dt><dd><input type="password" name="password" id="password" value="adminpass99" /></dd>
		</dl>
		<label><input type="checkbox" name="persistent" id="persistent" value="1" /> Remember me.</label>
		<input type="submit" value="Login" />
	</form>
</div>

<div id="login-with-tfa-section" style="display:none;">
	<form id="login-with-tfa-form" method="post" onsubmit="return false;">
		<dl>
			<dt>TFA Code</dt><dd><input type="text" name="tfa-code" id="tfa-code" value="" /></dd>
		</dl>
		<input type="submit" value="Login" />
	</form>
</div>


<div id="tfa-info" style="display:none; padding: 8px;">
	<div id="qrcode" style="sdisplay:none;"></div>
	<br />
	<div id="tfa_secret">22FV2Q67YAL33L7DONB4QLSTGIPONJYBDFMVJPI</div>
</div>
<br />
<a href="javascript:toggle_tfa();" style="opacity:0.5">Show/Hide 2FA (For Test)</a>


<script type="text/javascript">

var qrcode = new QRCode(document.getElementById("qrcode"), {
	text: "otpauth://totp/Issuer:Label?issuer=Issuer&secret=22FV2Q67YAL33L7DONB4QLSTGIPONJYBDFMVJPI&algorithm=SHA1&digits=6&period=30",
	width: 200,
	height: 200,
	colorDark: "#000000",
	colorLight: "#ffffff",
	correctLevel: QRCode.CorrectLevel.H
});

console.log(document.cookie);

function toggle_tfa() {
	$('#tfa-info').toggle();
};


$('#login-form').on('submit', function() {
	var requestData = {
		namespace		: 'admin',
		credentials		: {
			username	: $('#username').val(),
			password	: $('#password').val()
		},
		persistent		: $('#persistent').is(':checked')
	};

	console.log(requestData);

	$.ajax({
		type: "POST",
		contentType: "application/json",
		url: "/api/1.0/authentication/login",
		data: JSON.stringify(requestData),
		dataType: 'json',
		success: function(response) {
			console.log('response', response);
			if (response.d) {
				if (response.d.status === 'ok') {
					window.location.replace('/admin/');

				} else if (response.d.status === 'tfa_required') {
					$('#login-section').hide();
					$('#login-with-tfa-section').show();
				}
			}
		}
	});

	return false;
});

$('#login-with-tfa-form').on('submit', function() {
	var requestData = {
		namespace	: 'admin',
		code		: $('#tfa-code').val()
	};

	console.log(requestData);

	$.ajax({
		type: "POST",
		contentType: "application/json",
		url: "/api/1.0/authentication/login_with_tfa",
		data: JSON.stringify(requestData),
		dataType: 'json',
		success: function(response) {
			console.log('response', response);
			if (response.d && response.d.status === 'ok') {
				window.location.replace('/admin/');
			} else if (response.e && response.e.name === 'client_exception/login_required') {
				$('#login-section').show();
				$('#login-with-tfa-section').hide();
			}
		}
	});

	return false;
});

$(document).ready(function() {

});

</script>
</body>
</html>
